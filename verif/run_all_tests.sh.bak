#!/usr/bin/env bash
set -euo pipefail

ROOT="$(cd "$(dirname "$0")/.." && pwd)"
cd "$ROOT" || exit 1

LOGDIR="$ROOT/verif/logs"
mkdir -p "$LOGDIR"

# User override: point to the cocotb libs directory inside venv
COCOTB_LIBS="${COCOTB_LIBS:-$ROOT/.venv/lib/python3.10/site-packages/cocotb/libs}"
VVP_BIN="${VVP_BIN:-/usr/bin/vvp}"
TIMEOUT_CMD="${TIMEOUT_CMD:-timeout}"    # use coreutils timeout; override if needed
TIME_LIMIT="${TIME_LIMIT:-120s}"         # adjust if you want longer

echo "Project root: $ROOT"
echo "Logs -> $LOGDIR"
echo ""

# discover tests
tests=( $(ls verif/tb/test_*.py 2>/dev/null || true) )
if [ ${#tests[@]} -eq 0 ]; then
  echo "No tests found in verif/tb/"
  exit 1
fi

echo "Discovered ${#tests[@]} candidate test files:"
for t in "${tests[@]}"; do
  echo " - $t"
done
echo ""

passed=()
failed=()

run_one() {
  testfile="$1"
  module="$(basename "$testfile" .py)"
  logfile="$LOGDIR/${module}.log"
  echo "=== Running MODULE=$module ==="
  echo "Test file: $testfile"
  echo "Log: $logfile"

  # build via make (keeps Makefile logic for building sim.vvp)
  if ! make -C verif SIM=icarus TOPLEVEL=soc_top MODULE="$module" >"$logfile" 2>&1; then
    echo "make FAILED for $module. See $logfile"
    failed+=("$module")
    return 1
  fi

  # expected sim.vvp location created by Make:
  sim_vvp="verif/sim_build_tb_${module}/sim.vvp"
  if [ ! -f "$sim_vvp" ]; then
    echo "sim.vvp not found at $sim_vvp; failing $module" | tee -a "$logfile"
    failed+=("$module")
    return 1
  fi

  # run the simulator with the vvp interpreter (and timeout) and append to logfile
  echo "Running vvp (with timeout $TIME_LIMIT) - invoking: $VVP_BIN -M $COCOTB_LIBS -m libcocotbvpi_icarus $sim_vvp" | tee -a "$logfile"

  # run it under timeout to avoid indefinite hangs
  if $TIMEOUT_CMD --preserve-status "$TIME_LIMIT" "$VVP_BIN" -M "$COCOTB_LIBS" -m libcocotbvpi_icarus "$sim_vvp" >>"$logfile" 2>&1; then
    echo "make completed for $module" | tee -a "$logfile"
    passed+=("$module")
    return 0
  else
    echo "Execution FAILED/TIMED OUT for $module (see $logfile)" | tee -a "$logfile"
    failed+=("$module")
    return 1
  fi
}

# iterate
for t in "${tests[@]}"; do
  run_one "$t"
  echo
done

# summary
echo "=== SUMMARY ==="
echo "Passed: ${#passed[@]}"
for p in "${passed[@]}"; do echo "  $p"; done
echo ""
echo "Failed: ${#failed[@]}"
for f in "${failed[@]}"; do echo "  $f"; done

echo ""
echo "Inspect logs in $LOGDIR for failing modules."
echo "Full summary written to $LOGDIR/summary.txt"
{
  echo "Passed: ${#passed[@]}"
  for p in "${passed[@]}"; do echo "  $p"; done
  echo "Failed: ${#failed[@]}"
  for f in "${failed[@]}"; do echo "  $f"; done
} > "$LOGDIR/summary.txt"

